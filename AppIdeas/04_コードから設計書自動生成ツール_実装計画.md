# コードから設計書自動生成ツール - 実装計画

## 対応環境
- **オンライン処理**: VB.NET
- **データベース**: Oracle 19c
- **バッチ処理**: PL/SQL

## 実現可能性
✅ **可能です**

各技術に対応するパーサー・ライブラリが存在します。

## 技術選定

### 1. VB.NET解析
- **Tree-sitter VB.NET Parser** (推奨)
  - npm経由でインストール可能
  - PythonからNode.js経由で呼び出し可能
  - または、Python用のTree-sitterバインディングを使用
- **代替案**: Roslyn（.NET環境が必要）

### 2. PL/SQL解析
- **ZPA (Zero PL/SQL Analyzer)** (推奨)
  - Pythonベース
  - ANTLR4ベースのパーサー
  - 静的解析機能も含む
- **代替案**: bytebase/plsql-parser (ANTLR4ベース)

### 3. Oracle 19cスキーマ抽出
- **python-oracledb** (旧cx_Oracle)
  - DBMS_METADATA.GET_DDLを使用してDDLを取得
  - テーブル、ビュー、プロシージャ、ファンクション、トリガー等を抽出可能

## 実装アプローチ

### フェーズ1: 最小限のプロトタイプ（推奨開始点）

#### 1-1. Oracleスキーマ情報の抽出（最も簡単）
**目的**: データベーススキーマから設計書を生成

**実装内容**:
- Python + python-oracledbでOracleに接続
- DBMS_METADATA.GET_DDLでテーブル定義を取得
- テーブル一覧、カラム情報、制約情報を抽出
- Markdown形式で設計書を生成

**メリット**:
- データベース接続のみで実装可能
- コード解析より簡単
- 即座に価値を提供できる

**必要なもの**:
```python
# 必要なライブラリ
pip install oracledb  # または cx_Oracle
```

**出力例**:
```markdown
# データベース設計書

## テーブル一覧
- TABLE1
- TABLE2

## TABLE1
| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| ID | NUMBER | NOT NULL | | 主キー |
```

#### 1-2. PL/SQLプロシージャ・ファンクションの抽出
**目的**: PL/SQLのバッチ処理を設計書化

**実装内容**:
- Oracleからプロシージャ・ファンクションのソースコードを取得
- プロシージャ名、パラメータ、処理概要を抽出
- Markdown形式で設計書を生成

**必要なもの**:
```python
# Oracleからソースコード取得
SELECT text FROM all_source 
WHERE owner = :schema AND name = :procedure_name
ORDER BY line;
```

### フェーズ2: VB.NETコード解析

#### 2-1. Tree-sitterのセットアップ
**実装内容**:
- Tree-sitter VB.NETパーサーをインストール
- Python用のtree-sitterバインディングを使用
- VB.NETファイルを解析してクラス、メソッドを抽出

**必要なもの**:
```bash
# Node.jsが必要
npm install tree-sitter tree-sitter-vb-dotnet

# Python側
pip install tree-sitter
```

**実装の流れ**:
1. VB.NETファイルを読み込む
2. Tree-sitterでパース
3. ASTを走査してクラス、メソッド、プロパティを抽出
4. Markdown形式で設計書を生成

### フェーズ3: 統合と高度な機能

#### 3-1. 複数ソースの統合
- VB.NET、PL/SQL、Oracleスキーマ情報を統合
- 関連性を自動で関連付け（例: VB.NETのメソッドとPL/SQLプロシージャの対応）

#### 3-2. テンプレート機能
- 設計書のフォーマットをカスタマイズ可能に
- プロジェクトごとにテンプレートを切り替え

#### 3-3. 差分検出
- Git等と連携してコード変更を検出
- 設計書の更新が必要な箇所を自動検出

## 推奨実装順序

### ステップ1: Oracleスキーマ抽出ツール（1-2週間）
**理由**: 
- 最も簡単で即座に価値を提供できる
- データベース設計書は重要で、手動作成が大変
- 技術的ハードルが低い

**成果物**:
- OracleスキーマからMarkdown設計書を生成するPythonスクリプト
- テーブル定義、制約、インデックス情報を含む

### ステップ2: PL/SQL解析（1-2週間）
**理由**:
- Oracle接続の知識を活用できる
- バッチ処理の設計書化は価値が高い

**成果物**:
- PL/SQLプロシージャ・ファンクションの設計書を生成
- パラメータ、処理フローを抽出

### ステップ3: VB.NET解析（2-3週間）
**理由**:
- Tree-sitterのセットアップが必要
- より複雑だが、オンライン処理の設計書化は重要

**成果物**:
- VB.NETコードからクラス図、API仕様を生成

### ステップ4: 統合とUI（2-3週間）
**理由**:
- 各機能を統合して使いやすくする
- CLIまたはシンプルなGUIを提供

## 最初の一歩（今すぐ始められること）

### 最小限のプロトタイプ: Oracleテーブル定義書生成

```python
# ファイル名: oracle_schema_extractor.py
import oracledb
from typing import List, Dict

def extract_table_ddl(connection, table_name: str) -> str:
    """テーブルのDDLを取得"""
    cursor = connection.cursor()
    
    # CLOBを文字列として取得するための設定
    def output_type_handler(cursor, name, default_type, size, precision, scale):
        if default_type == oracledb.DB_TYPE_CLOB:
            return cursor.var(oracledb.DB_TYPE_LONG_STRING, arraysize=cursor.arraysize)
    
    cursor.outputtypehandler = output_type_handler
    cursor.execute("""
        SELECT DBMS_METADATA.GET_DDL('TABLE', :table_name) 
        FROM DUAL
    """, table_name=table_name)
    
    ddl, = cursor.fetchone()
    return ddl

def generate_markdown_design_doc(connection, schema: str) -> str:
    """スキーマ全体の設計書をMarkdown形式で生成"""
    cursor = connection.cursor()
    
    # テーブル一覧を取得
    cursor.execute("""
        SELECT table_name 
        FROM all_tables 
        WHERE owner = :schema
        ORDER BY table_name
    """, schema=schema)
    
    tables = [row[0] for row in cursor.fetchall()]
    
    markdown = f"# {schema} データベース設計書\n\n"
    markdown += "## テーブル一覧\n\n"
    
    for table in tables:
        markdown += f"- {table}\n"
        # テーブル定義を取得して追加
        ddl = extract_table_ddl(connection, table)
        markdown += f"\n### {table}\n\n```sql\n{ddl}\n```\n\n"
    
    return markdown

# 使用例
if __name__ == "__main__":
    conn = oracledb.connect(
        user="username",
        password="password",
        dsn="hostname:port/service_name"
    )
    
    doc = generate_markdown_design_doc(conn, "SCHEMA_NAME")
    with open("database_design.md", "w", encoding="utf-8") as f:
        f.write(doc)
    
    conn.close()
```

## 必要な環境・ツール

### 必須
- Python 3.8以上
- Oracle 19cへの接続権限
- python-oracledb ライブラリ

### フェーズ2以降で必要
- Node.js (Tree-sitter用)
- Tree-sitter VB.NET Parser

## 参考資料

### VB.NET解析
- [Tree-sitter VB.NET Parser](https://docs.codeant.ai/open_source/vb-dot-net)
- [Microsoft.CodeAnalysis.VisualBasic](https://learn.microsoft.com/en-us/dotnet/api/microsoft.codeanalysis.visualbasic)

### PL/SQL解析
- [ZPA - Zero PL/SQL Analyzer](https://zpa.felipebz.com/)
- [bytebase/plsql-parser](https://github.com/bytebase/plsql-parser)

### Oracleスキーマ抽出
- [python-oracledb Documentation](https://python-oracledb.readthedocs.io/)
- [DBMS_METADATA Documentation](https://docs.oracle.com/en/database/oracle/oracle-database/19/arpls/DBMS_METADATA.html)
